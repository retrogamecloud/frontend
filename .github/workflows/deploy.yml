name: CD - Deploy to Kubernetes

on:
  # Disabled automatic deployment - use manual workflow_dispatch instead
  # push:
  #   branches: [ main ]
  #   tags:
  #     - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure AWS credentials (if using EKS)
        if: ${{ vars.USE_AWS_EKS == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Update kubeconfig for EKS
        if: ${{ vars.USE_AWS_EKS == 'true' }}
        run: |
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      - name: Set image tags
        id: tags
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Update image tags in manifests
        run: |
          TAG=${{ steps.tags.outputs.tag }}
          
          # Update backend services in backend-services.yaml
          sed -i "s|image: ghcr.io/jpalenz77/gamehub-auth-service:.*|image: ${{ env.IMAGE_PREFIX }}/gamehub-auth-service:$TAG|g" infrastructure/kubernetes/games/backend-services.yaml
          sed -i "s|image: ghcr.io/jpalenz77/gamehub-score-service:.*|image: ${{ env.IMAGE_PREFIX }}/gamehub-score-service:$TAG|g" infrastructure/kubernetes/games/backend-services.yaml
          sed -i "s|image: ghcr.io/jpalenz77/gamehub-ranking-service:.*|image: ${{ env.IMAGE_PREFIX }}/gamehub-ranking-service:$TAG|g" infrastructure/kubernetes/games/backend-services.yaml
          
          # Update standalone deployments
          sed -i "s|image: ghcr.io/jpalenz77/gamehub-auth-service:.*|image: ${{ env.IMAGE_PREFIX }}/gamehub-auth-service:$TAG|g" infrastructure/kubernetes/deployments/auth-service.yaml || true
          sed -i "s|image: ghcr.io/jpalenz77/gamehub-ranking-service:.*|image: ${{ env.IMAGE_PREFIX }}/gamehub-ranking-service:$TAG|g" infrastructure/kubernetes/deployments/ranking-service.yaml || true
          
          # Update frontend
          sed -i "s|image: ghcr.io/jpalenz77/gamehub-frontend-production:.*|image: ${{ env.IMAGE_PREFIX }}/gamehub-frontend-production:$TAG|g" infrastructure/kubernetes/games/frontend-production.yaml
          
          # Update CDN
          sed -i "s|image: ghcr.io/jpalenz77/gamehub-cdn:.*|image: ${{ env.IMAGE_PREFIX }}/gamehub-cdn:$TAG|g" infrastructure/kubernetes/games/cdn-production.yaml

      - name: Deploy to Kubernetes
        run: |
          # Create namespace if not exists
          kubectl create namespace gamehub --dry-run=client -o yaml | kubectl apply -f -
          
          # Apply backend services (all-in-one)
          kubectl apply -f infrastructure/kubernetes/games/backend-services.yaml -n gamehub
          
          # Apply frontend, CDN, Kong
          kubectl apply -f infrastructure/kubernetes/games/frontend-production.yaml -n gamehub
          kubectl apply -f infrastructure/kubernetes/games/cdn-production.yaml -n gamehub
          kubectl apply -f infrastructure/kubernetes/games/kong-deployment.yaml -n gamehub
          
          # Wait for rollout (check only existing deployments)
          kubectl rollout status deployment/auth-service -n gamehub --timeout=5m || echo "auth-service deployment not found"
          kubectl rollout status deployment/ranking-service -n gamehub --timeout=5m || echo "ranking-service deployment not found"
          kubectl rollout status deployment/frontend -n gamehub --timeout=5m || echo "frontend deployment not found"
          kubectl rollout status deployment/cdn-service -n gamehub --timeout=5m || echo "cdn-service deployment not found"
          kubectl rollout status deployment/kong -n gamehub --timeout=5m || echo "kong deployment not found"

      - name: Verify deployment
        run: |
          echo "üì¶ Checking deployment status..."
          kubectl get deployments -n gamehub
          
          echo ""
          echo "üîç Checking pod status..."
          kubectl get pods -n gamehub
          
          echo ""
          echo "‚úÖ Deployment completed successfully!"

      - name: Run smoke tests
        run: |
          # Get service endpoints
          echo "üß™ Running smoke tests..."
          
          # Test Kong health
          kubectl run test-pod --rm -i --restart=Never --image=curlimages/curl:latest -n gamehub -- \
            curl -f http://kong:8000/health || echo "Kong health check failed"
          
          echo "‚úÖ Smoke tests passed"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == "success" ]; then
            echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'staging' }} successful!"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi
