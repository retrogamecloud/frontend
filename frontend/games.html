<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>GameHub Retro - Selecci√≥n de Juegos</title>
    <link rel="stylesheet" href="retro.css">
    <link rel="stylesheet" href="./jsdos/js-dos.css">
    <script src="./jsdos/js-dos.js"></script>
    <script src="score-tracker.js"></script>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
      <circle cx='32' cy='32' r='24' fill='black' stroke='%2300ff88' stroke-width='4'>
        <animate attributeName='stroke-opacity' values='1;0.3;1' dur='2s' repeatCount='indefinite'/>
      </circle>
    </svg>">
</head>
<body>
    
    <div class="grid"></div>

    <header>
        <h1>üéÆ GameHub Retro</h1>
        <button class="logout" id="logoutBtn">Salir</button>
    </header>

    <div class="game-select">
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('doom')">‚ñ∂Ô∏è Jugar DOOM</button>
            <img src="img/doom-thumb.jpg" alt="DOOM" class="game-thumb" onclick="loadGame('doom')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('wolf')">‚ñ∂Ô∏è Jugar Wolfstein 3D</button>
            <img src="img/wolf-thumb.jpg" alt="wolf" class="game-thumb" onclick="loadGame('wolf')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('dangerousdave2')">‚ñ∂Ô∏è Jugar Dangerous Dave 2</button>
            <img src="img/dangerous-thumb.jpg" alt="Dangerous" class="game-thumb" onclick="loadGame('dangerousdave2')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('digger')">‚ñ∂Ô∏è Jugar Digger</button>
            <img src="img/digger-thumb.jpg" alt="digger" class="game-thumb" onclick="loadGame('digger')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('dukenukem3d')">‚ñ∂Ô∏è Jugar Duke Nukem 3D</button>
            <img src="img/duke3d-thumb.jpg" alt="duke3d" class="game-thumb" onclick="loadGame('dukenukem3d')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('heroesofmightandmagic2')">‚ñ∂Ô∏è Jugar Heroes of Might and Magic 2</button>
            <img src="img/heroes-thumb.jpg" alt="HEROES" class="game-thumb" onclick="loadGame('heroesofmightandmagic2')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('lostvikings')">‚ñ∂Ô∏è Jugar Lost Vikings</button>
            <img src="img/lost-thumb.jpg" alt="lostvikings" class="game-thumb" onclick="loadGame('lostvikings')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('mortalkombat')">‚ñ∂Ô∏è Jugar Mortal Kombat</button>
            <img src="img/mortal-thumb.jpg" alt="mortalkombat" class="game-thumb" onclick="loadGame('mortalkombat')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('streetfighter2')">‚ñ∂Ô∏è Jugar Street Fighter 2</button>
            <img src="img/street-thumb.jpg" alt="streetfighter2" class="game-thumb" onclick="loadGame('streetfighter2')">
        </div>
        <div class="game-card">
            <button class="game-btn" onclick="loadGame('tetris')">‚ñ∂Ô∏è Jugar Tetris</button>
            <img src="img/tetris-thumb.jpg" alt="Tetris" class="game-thumb" onclick="loadGame('tetris')">
        </div>
    </div>

    <div id="loader"></div>
    <div id="dosbox-container">
        <div id="dosbox" style="display: none;"></div>
    </div>

    <section id="ranking">
        <h2>üèÜ Clasificaci√≥n de Jugadores - <span id="current-game">DOOM</span></h2>
        <div class="ranking-tabs">
            <button class="ranking-tab active" onclick="switchRanking('doom')">DOOM</button>
            <button class="ranking-tab" onclick="switchRanking('wolf')">Wolfenstein 3D</button>
            <button class="ranking-tab" onclick="switchRanking('dangerousdave2')">Dangerous Dave 2</button>
            <button class="ranking-tab" onclick="switchRanking('digger')">Digger</button>
            <button class="ranking-tab" onclick="switchRanking('dukenukem3d')">Duke Nukem 3D</button>
            <button class="ranking-tab" onclick="switchRanking('heroesofmightandmagic2')">Heroes of Might and Magic 2</button>
            <button class="ranking-tab" onclick="switchRanking('lostvikings')">Lost Vikings</button>
            <button class="ranking-tab" onclick="switchRanking('mortalkombat')">Mortal Kombat</button>
            <button class="ranking-tab" onclick="switchRanking('streetfighter2')">Street Fighter 2</button>  
            <button class="ranking-tab" onclick="switchRanking('tetris')">Tetris</button>
        </div>
        <table>
            <thead>
                <tr><th>Posici√≥n</th><th>Jugador</th><th>Puntuaci√≥n</th><th>Fecha</th></tr>
            </thead>
            <tbody id="ranking-body">
                <tr><td colspan="4">Cargando ranking...</td></tr>
            </tbody>
        </table>
    </section>

    <section id="instructions">
        <h2>üïπÔ∏è Controles</h2>
        <ul>
            <li><b>Movimiento:</b> Flechas o WASD</li>
            <li><b>Disparar:</b> CTRL</li>
            <li><b>Usar / Abrir puertas:</b> ESPACIO</li>
            <li><b>Correr:</b> SHIFT (mantener)</li>
            <li><b>Cambiar arma:</b> 1‚Äì7</li>
            <li><b>Pantalla completa:</b> F11 o bot√≥n del juego</li>
            <li><b>Rat√≥n:</b> clic dentro del juego para capturarlo</li>
        </ul>
    </section>

    <script>
        // API URLs - All through Kong Gateway
        const API = "http://localhost:8000/api/auth"; // auth-service through Kong
        const SCORE_API = "http://localhost:8000/api/scores"; // score-service through Kong
        const RANKING_API = "http://localhost:8000/api/rankings"; // ranking-service through Kong
        
        let accessToken = localStorage.getItem("accessToken");
        const refreshToken = localStorage.getItem("refreshToken");
        const username = localStorage.getItem("username");
        const userId = localStorage.getItem("userId");
        const loader = document.getElementById("loader");
        let container = document.getElementById("dosbox"); // üÜï Cambiado a let para poder reasignar
        const rankingBody = document.getElementById("ranking-body");
        let currentRankingGame = "doom";
        let currentScoreSystem = null;
        let isRedirecting = false; // üÜï Flag para evitar cargas durante redirecci√≥n

        // üÜï Funci√≥n para verificar si el token est√° expirado
        function isTokenExpired(token) {
            if (!token) return true;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.exp * 1000 < Date.now();
            } catch (e) {
                return true;
            }
        }

        // üÜï Funci√≥n para renovar el token
        async function refreshAccessToken() {
            if (!refreshToken) return false;
            
            try {
                const res = await fetch(`${API}/refresh`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ refreshToken })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    accessToken = data.accessToken;
                    localStorage.setItem("accessToken", data.accessToken);
                    console.log("‚úÖ Token renovado exitosamente");
                    return true;
                }
            } catch (err) {
                console.error("‚ùå Error al renovar token:", err);
            }
            return false;
        }

        const JUEGOS_TITULOS = {
            "doom": "DOOM",
            "wolf": "Wolfenstein 3D",
            "dangerousdave2": "Dangerous Dave 2",
            "digger": "Digger",
            "dukenukem3d": "Duke Nukem 3D",
            "heroesofmightandmagic2": "Heroes of Might and Magic 2",
            "lostvikings": "Lost Vikings",
            "mortalkombat": "Mortal Kombat",
            "streetfighter2": "Street Fighter 2",
            "tetris": "Tetris"
        };

        // Verificar si est√° logueado (opcional para jugar, pero necesario para guardar scores)
        const isLoggedIn = !!accessToken;
        if (!isLoggedIn) {
            console.warn("‚ö†Ô∏è No est√°s logueado. Puedes jugar pero no guardar puntuaciones.");
        }

        // Cargar ranking inicial al abrir la p√°gina
        loadRanking("doom");

        document.getElementById("logoutBtn").onclick = () => {
            localStorage.clear();
            window.location.href = "./index.html";
        };

        async function saveScore(game, score, retryCount = 0) {
            // Prevenir bucle infinito
            if (retryCount > 2) {
                console.error("‚ùå Demasiados reintentos, abortando");
                isRedirecting = true;
                alert("üîí Error al guardar puntuaci√≥n despu√©s de varios intentos.\n\nPor favor, inicia sesi√≥n nuevamente.\n\nRedirigiendo al login...");
                localStorage.clear();
                setTimeout(() => window.location.href = "./index.html", 3000);
                return;
            }
            
            // Si no est√° logueado, no intentar guardar
            if (!accessToken) {
                console.warn("‚ö†Ô∏è Debes iniciar sesi√≥n para guardar tu puntuaci√≥n");
                isRedirecting = true;
                alert("‚ö†Ô∏è No est√°s logueado.\n\n‚úÖ Puedes jugar libremente.\n‚ùå NO se guardar√°n tus puntuaciones.\n\nRedirigiendo al login...");
                setTimeout(() => window.location.href = "./index.html", 3000);
                return;
            }

            // üÜï Verificar si el token expir√≥ y renovarlo (solo en primer intento)
            if (retryCount === 0 && isTokenExpired(accessToken)) {
                console.log("‚è∞ Token expirado, intentando renovar...");
                const renewed = await refreshAccessToken();
                
                if (!renewed) {
                    console.error("‚ùå No se pudo renovar el token");
                    isRedirecting = true;
                    alert("üîí Tu sesi√≥n ha expirado y no se pudo renovar.\n\nPor favor, inicia sesi√≥n nuevamente.\n\nRedirigiendo al login...");
                    localStorage.clear();
                    setTimeout(() => window.location.href = "./index.html", 3000);
                    return;
                }
                // Actualizar el token despu√©s del refresh
                accessToken = localStorage.getItem("accessToken");
            }

            try {
                const res = await fetch(`${SCORE_API}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type":"application/json",
                        "Authorization":`Bearer ${accessToken}`
                    },
                    body: JSON.stringify({game, score})
                });
                
                if (res.status === 403 || res.status === 401) {
                    console.error(`‚ùå Token inv√°lido o expirado (intento ${retryCount + 1}/3)`);
                    
                    // Intentar renovar una vez m√°s
                    const renewed = await refreshAccessToken();
                    if (renewed) {
                        // Actualizar accessToken antes de reintentar
                        accessToken = localStorage.getItem("accessToken");
                        console.log("üîÑ Reintentando con nuevo token...");
                        
                        // Reintentar guardar con nuevo token (incrementar contador)
                        return saveScore(game, score, retryCount + 1);
                    }
                    
                    isRedirecting = true;
                    alert("üîí Tu sesi√≥n ha expirado.\n\nPor favor, inicia sesi√≥n nuevamente.\n\nRedirigiendo al login...");
                    localStorage.clear();
                    setTimeout(() => window.location.href = "./index.html", 3000);
                    return;
                }
                
                const data = await res.json();
                console.log("‚úÖ Puntuaci√≥n guardada:", data);
                
                // Actualizar el ranking despu√©s de guardar
                await loadRanking(game);
            } catch (err) {
                console.error("Error al guardar puntuaci√≥n:", err);
            }
        }

        async function loadRanking(game) {
            try {
                currentRankingGame = game;
                const res = await fetch(`${RANKING_API}/games/${game}`);
                const data = await res.json();
                
                const title = JUEGOS_TITULOS[game] || game.toUpperCase();
                document.getElementById("current-game").textContent = title;
                
                // Actualizar las pesta√±as activas
                document.querySelectorAll(".ranking-tab").forEach(tab => {
                    tab.classList.remove("active");
                });
                // üü¢ CORRECCI√ìN: Usar el valor exacto del juego en el selector
                document.querySelector(`[onclick="switchRanking('${game}')"]`).classList.add("active");
                
                // Actualizar la tabla
                rankingBody.innerHTML = "";
                if (data.length === 0) {
                    rankingBody.innerHTML = '<tr><td colspan="4">No hay puntuaciones todav√≠a</td></tr>';
                } else {
                    data.forEach((r, index) => {
                        const position = index + 1;
                        const emoji = position === 1 ? "ü•á" : position === 2 ? "ü•à" : position === 3 ? "ü•â" : position;
                        const rowClass = r.username === username ? 'class="my-score"' : '';
                        const date = new Date(r.created_at).toLocaleString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            timeZone: 'Europe/Madrid'
                        });
                        rankingBody.innerHTML += `<tr ${rowClass}><td>${emoji}</td><td>${r.username}</td><td>${r.score}</td><td>${date}</td></tr>`;
                    });
                }
            } catch (err) {
                console.error("Error al cargar ranking:", err);
                rankingBody.innerHTML = '<tr><td colspan="4">Servicio de rankings no disponible</td></tr>';
            }
        }

        function switchRanking(game) {
            loadRanking(game);
        }

        async function loadGame(game) {
            console.log(`üéÆ loadGame llamado con: ${game}`);
            console.log(`üìç container actual:`, container);
            
            // üõë NO cargar juegos si estamos redirigiendo al login
            if (isRedirecting) {
                console.warn("‚ö†Ô∏è Redirigiendo al login, no se cargar√° el juego");
                return;
            }

            // üßπ LIMPIEZA COMPLETA antes de cargar nuevo juego
            if (window.ciInstance) {
                try {
                    console.log("üßπ Limpiando instancia anterior de JS-DOS...");
                    if (window.ciInstance.exit) {
                        await window.ciInstance.exit();
                    }
                } catch (e) {
                    console.warn("‚ö†Ô∏è Error al limpiar instancia:", e);
                } finally {
                    window.ciInstance = null;
                }
            }
            
            // Limpiar tracker anterior si existe
            if (currentScoreSystem) {
                try {
                    currentScoreSystem.destroy();
                } catch (e) {
                    console.warn("‚ö†Ô∏è Error al destruir ScoreSystem:", e);
                } finally {
                    currentScoreSystem = null;
                }
            }
            
            // Limpiar completamente el contenedor DOM y recrear
            const dosboxContainer = document.getElementById("dosbox-container");
            // Remover todos los event listeners y contenido
            dosboxContainer.innerHTML = '';
            // Crear nuevo div dosbox limpio
            const newDosbox = document.createElement('div');
            newDosbox.id = 'dosbox';
            newDosbox.style.display = 'none';
            dosboxContainer.appendChild(newDosbox);
            container = newDosbox; // üÜï Reasignar la referencia global
            
            console.log(`üì¶ Container despu√©s de recrear:`, container);
            
            loader.textContent = `Cargando ${game.toUpperCase()}...`;
            
            // CDN URLs - Para testing local con docker-compose, usar puerto 8086
            // En producci√≥n con Ingress, ser√≠a: https://cdn.gamehub.com
            const CDN_URL = window.CDN_URL || 'http://localhost:8086/juegos';
            
            const JUEGOS_RUTAS = {
                "doom": `${CDN_URL}/doom.jsdos`,
                "wolf": `${CDN_URL}/wolf.jsdos`,
                "dangerousdave2": `${CDN_URL}/dangerousdave2.jsdos`, 
                "digger": `${CDN_URL}/digger.jsdos`,
                "dukenukem3d": `${CDN_URL}/duke3d.jsdos`,
                "heroesofmightandmagic2": `${CDN_URL}/heroesofmightandmagic2.jsdos`,
                "lostvikings": `${CDN_URL}/lostvikings.jsdos`,
                "mortalkombat": `${CDN_URL}/mortalkombat.jsdos`,
                "streetfighter2": `${CDN_URL}/streetfighter2.jsdos`,
                "tetris": `${CDN_URL}/tetris.jsdos` 
            };

            const url = JUEGOS_RUTAS[game] || "./juegos/default.jsdos";

            // Cargar el ranking del juego que se va a jugar
            await loadRanking(game);

            try {
                console.log(`üéÆ Cargando juego desde: ${url}`);
                console.log(`üì¶ Container antes de Dos():`, container);
                
                const ci = await Dos(container, {url, pathPrefix:"./jsdos/", mouseLock:true});
                window.ciInstance = ci;
                
                console.log(`‚úÖ Dos() ejecutado exitosamente`);
                
                // üÜï Iniciar sistema h√≠brido de puntuaci√≥n
                currentScoreSystem = new HybridScoreSystem(game, ci);
                console.log(`‚úÖ Tracking de puntuaci√≥n iniciado para ${game.toUpperCase()}`);
                
                loader.textContent = "";
                container.style.display = "block";
                
                console.log(`üì∫ Container display establecido a 'block'`);

                // üÜï Guardar la funci√≥n original de exit
                const originalExit = ci.exit;
                
                ci.exit = async () => {
                    console.log(`üèÅ Juego terminado, calculando puntuaci√≥n...`);
                    
                    // üÜï Obtener puntuaci√≥n (autom√°tica o manual seg√∫n tiempo jugado)
                    const score = await currentScoreSystem.getFinalScore();
                    console.log(`üìä Puntuaci√≥n final: ${score}`);
                    
                    // Guardar score solo si est√° logueado
                    await saveScore(game, score);
                    
                    // Limpiar sistema de puntuaci√≥n
                    if (currentScoreSystem) {
                        currentScoreSystem.destroy();
                        currentScoreSystem = null;
                    }
                    
                    // Llamar al exit original de JS-DOS
                    if (originalExit) {
                        try {
                            await originalExit.call(ci);
                        } catch (e) {
                            console.warn("‚ö†Ô∏è Error en exit original:", e);
                        }
                    }
                    
                    // üÜï Limpiar la instancia
                    window.ciInstance = null;
                    
                    console.log("‚úÖ Juego terminado y limpiado correctamente");
                };
                
                console.log("‚úÖ Juego cargado exitosamente");
            } catch (err) {
                loader.textContent = "";
                console.error("‚ùå Error al cargar juego:", err);
                alert(`Error al cargar ${game}: ${err.message}`);
            }
        }
    </script>
</body>
</html>